<!DOCTYPE html>
<html>
<head>
  	<title>Google Events Widget [ANTP]</title>
	
	<!-- CSS Files -->
    <link rel="stylesheet" href="css/jquery.mobile.theme.css" />
    <link rel="stylesheet" href="css/jquery.mobile.structure-1.0.1.css" />
	<link rel="stylesheet" href="css/style.css" />
	
	<!--  JS Files -->
    <script src="js/jquery.js" type="text/javascript"></script>
	<script src="js/jquery.mobile-1.0.1.min.js"></script>
    <script src="js/jquery.utility.js"></script>
    <script src="js/jquery.xcolor.js"></script>
	<script src="js/helpers.js"></script>
	<script src="js/jquery.mousewheel.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>


    <script src="js/ext-core.js"></script>
    <script src="js/calendar.js"></script>
	
    <script>
		
        $(document).bind("mobileinit", function(){
          $.extend(  $.mobile , {
            ajaxEnabled: false
          });
        });

        //Browser On Load Event
		$(document).ready(function() {

            var local_storage_events = localStorage.getItem("events") || "";
            var alert_shown = false;
            var $cal = $('#events');

            $('.google-header').mouseover(function(){
                $(this).find('#settings').stop().fadeTo('300', 1);
            }).mouseout(function(){
                $(this).find('#settings').stop().fadeTo(1600, .4);
            });

            log('OPENING STORAGE', localStorage);

            // When anything in localStorage changes
            $(window).bind('storage', local_storage_callback);

            function local_storage_callback(e) {
                log("[EVENT] Storage Changed", localStorage);
                var incoming_events = localStorage.getItem("events") || "";
                var widget_update = localStorage.getItem("widget_update") || false;
                var widget_notify = localStorage.getItem("widget_notify") || false;
                var widget_alert = localStorage.getItem("widget_alert") || false;
                var require_login = localStorage.getItem("require_login") || false;

                if(require_login){
                    alert_user(true, getResourceString('SESSION_ERROR_ALERT', ["https://www.google.com/calendar/"]));
                }
                
                if(widget_alert){
                    var msg = localStorage.getItem("widget_alert_msg");
                    log("MESSAGE: ", msg);
                    alert_user(true, msg);
                    localStorage.removeItem("widget_alert_msg");
                    localStorage.removeItem("widget_alert");
                }

                if(widget_notify){
                    var msg = localStorage.getItem("widget_notify_msg");
                    log("MESSAGE: ", msg);
                    localStorage.removeItem("widget_notify_msg");
                    localStorage.removeItem("widget_notify");
                }

                //Check if any events changed or where added
                if(widget_update || (local_storage_events.localeCompare(incoming_events) != 0 && incoming_events.length > 0)){
                    log("[NOTICE] Some events have changed. Forced=" + widget_update);
                    localStorage.removeItem("widget_update");
                    local_storage_events = incoming_events;
                    updateContent();
                }
            };

            /*
                Main Update function. Loads the events from the localstorage
                and displays them.
             */
			function updateContent(){
				events = JSON.parse(local_storage_events) || "";
                events == null ? events = [] : true;
                log("[DEBUG] Updating Content with Events: ", events);
				
				var now = new Date();
				var eventCount = 0, displayEventWithoutAllDayCount = 0, displayEventCount = 0, nextEventIndex = -1;
				if (events.length == 0) {
                    
					return;
				}
				//<ul data-role="listview" data-theme="a" data-divider-theme="c">
				var $list = $('.events_ul').empty().addClass('event_list')
						.attr('data-role', 'listview')
						.attr('data-theme', 'a')
						.attr('data-divider-theme', 'c');
				
				var displayDayCount = localStorage.getItem("numDays"), offset = 0;
				for (var index = 0, showDays = (!isNaN(displayDayCount)) ? displayDayCount : 5; index < showDays; index++) {
					offset = index;
					var cStart = new Blz.GData.Date().addDays(offset).resetHours(),
						cEnd = new Date(cStart.date.getFullYear(), cStart.date.getMonth(), cStart.date.getDate(), 23, 59, 59, 0);

					var header = getHeaderDateString(cStart);
					if (offset == 0) header += ' - ' + getResourceString('TODAY');
					else if (offset == 1) header += ' - ' + getResourceString('TOMORROW');
					$list.append($.fn._cal_header(header, 0));

					events.sort($.fn.appointmentCompare);

					for (var i=0, len=events.length; i<len; i++) {

						//convert start/end to date object
						var event = events[i];
						event.start = new Date(event.start);
						event.end = new Date(event.end);
						//Check if the event belongs in this day
						if(event.end<=cStart.date||event.start>=cEnd) continue;
						if(event.allDay == 0 && event.end < now) continue;
						eventCount++;

						var location = (event.location && event.location.length > 0) ? event.location : '';
						var time = (event.allDay) ? getResourceString('ALL_DAY_EVENT') : getTimeString(event.start);
						var color = $.xcolor.lighten(event.color, 3, 25);
						var remain = (now < event.start) ? getRemainTimeString(event.start) : '';
						var tooltip = [event.title,time,remain,location].join(' ');

						var $li = $.fn._cal_event(event.title, location, time, event.link, color);
						$list.append($li.attr({title:tooltip}));
						displayEventCount++;
					}

				}
					
				$list.listview('refresh');
				update_cal_header_counts($list);

				$('#events ul').bind('mousewheel', function(e, d) {	
					var height = $('#events ul').height(), scrollHeight = $('#events ul').get(0).scrollHeight;
					if((this.scrollTop === (scrollHeight - height) && d < 0) || (this.scrollTop === 0 && d > 0)) {
						e.preventDefault();
					}
				});
			}

            function update_cal_header_counts($list){
                $list.find('li[data-role="list-divider"]').each(function(){
                   var total = $(this).nextUntil('li[data-role="list-divider"]').length;
                   $(this).find('span.ui-li-count').html(total);
                });
            }

            /* Alerts the user */
            function alert_user(show, msg){
                $("#loader-box").stop().animate({top: show ? "35px" : $("body").height()}, 2000, 'easeOutBounce');
                if(!alert_shown){
                    $("#loader-box").html("");
                }
                $("#loader-box").append($("<h1/>").html(msg));
                alert_shown = show;
            }
            //Trigger storage to show messages
            $(window).trigger('storage');
            //updateContent();
    	});
    </script>
</head>
<body>
    <ul id="loader-box" class="ui-loader ui-body-a">
        <span class="ui-icon ui-icon-loading spin"></span>
    </ul>

	<div id="events" class="ui-mobile-viewport ui-overlay-a" data-role="page" data-theme="a">
        <div class="google-header" data-role="header" data-theme="b">
            <h1><a href="https://www.google.com/calendar/" target="_top"  data-role="none">Google Calendar</a></h1>
            <a id="settings" data-role="none" href="options.html" target="_top"><span data-role="none"></span></a>
        </div><!-- /header -->

        <ul class="events_ul" data-role="listview" data-inline="true" data-theme="a" data-divider-theme="c">
            <li>No Items</li>
        </ul>
	</div>
</body>
</html>