<!--
   - For https://chrome.google.com/webstore/detail/mgmiemnjjchgkmgbeljfocdjjnpjnmcg
   -->
<script src="js/jquery.js"></script>
<script src="js/ext-core.js"></script>
<script src="js/calendar.js"></script>
<script src="js/helpers.js"></script>

<script type="text/javascript">
	// Learn more about poke v2 here:
	// https://github.com/michaelhart/Awesome-New-Tab-Page/wiki/Poke-v2
	var info = {
	  "poke"    :   2,              // poke version 2
	  "width"   :   1,              // 406 px default
	  "height"  :   2,              // 200 px default
	  "path"    :   "widget.html",
	  "v2"      :   {
	                  "resize"    :   false,  // Set to true ONLY if you create a range below.
	                  "min_width" :   1,
	                  "max_width" :   1,
	                  "min_height":   1,
	                  "max_height":   2
	                }
	};
	
	chrome.extension.onRequestExternal.addListener(function(request, sender, sendResponse) {
	  if(request === "mgmiemnjjchgkmgbeljfocdjjnpjnmcg-poke") {
	    chrome.extension.sendRequest(
	      sender.id,
	      {
	        head: "mgmiemnjjchgkmgbeljfocdjjnpjnmcg-pokeback",
	        body: info,
	      }
	    );
	  }
	});

    $(document).ready(function() {
	    		
        var w = Blz.Widget,
            gcal = Blz.Google.Calendar,
            app = MyGoogleCal.Application;
        window.localStorage.removeItem('events'); //clear events from storage
        w.initialize(); //sets up widget cookie
        gcal.source = 'shayko-GoogleEventsANTP-1';
        gcal.useGoogleLogin = (w.getPref('useGoogleApps')!='1') ? false : true;
        w.setPref("offset", 0);
        app.initialize();

        function update(force) {

            log("[NOTICE] Updating Background Page");

            if (force) {
                log("[NOTICE] Forced Update!");
                app.retrieveAllCalendar();
                return;
            }
            if (app.isLoginRequesting()) {
                log("[WARNING] Request Login!");
                widget_notify_user( w.getResourceString('NOW_LOGIN'));
                return;
            }
            if (!app.isLogin()) {
                log("[WARNING] Not Logged In!");
                if (app.isGoogleApps()) {
                    // required client login, go to option
                    widget_notify_user(w.getResourceString('SESSION_ERROR_ALERT', [chrome.extension.getURL("options.html")]))
                }else {
                    // In Google account, extension will work with browser session.
                    widget_notify_user(w.getResourceString('SESSION_ERROR_ALERT', [app.getCalendarUrl()]));
                }
                return;
            }
            if (app.isCalendarListRequesting()) {
                log("[WARNING] Calendar is already requesting.");
                widget_notify_user("Updating Calendars...");
                return;
            }
            if (app.gcal.cacheCalendars.length==0){
                log("[WARNING] No cached calendars");
                widget_notify_user("No Calendars...");
                return;
            }
            var displayDayCount = (!isNaN(w.getPref('displayDayCount'))) ? w.getPref('displayDayCount') : 5;
            for (var offset = 0; offset < displayDayCount; offset++) {
                var cStart = new Blz.GData.Date().addDays(offset).resetHours();
                var events = [], cache = app.getAppointments(cStart); // copy the array to add repeaters
                for (calid in cache.items) {
                    var cal = app.findCalendarById(calid);
                    if (cal && cal.selected) {
                        events = events.concat(cache.items[calid]);
                    } else {
                        //w.print('"'+cal.title['#text']+'" calendar is not selected.');
                    }
                }
            }
            localStorage.setItem("events", JSON.stringify(events));
            chrome.extension.sendRequest({name: "update"});
        }

        var observer = {
            onMyGoogleCalLoginCompleted: function(sender, event) {
                log("[EVENT] Cal Login Complete", event);
                if (event.success) {
                    app.retrieveAllCalendar();
                }
                update();
            },
            onMyGoogleCalCalendarLoaded: function(sender, event) {
                log("[EVENT] Calendar Loaded", event);
                log("[DEBUG] Cached Calendars", gcal.cacheCalendars);
                update();
            },
            onMyGoogleCalEventLoaded: function(sender, event) {
                log("[EVENT] Event Loaded", event);
                update();
            }
        };

        function widget_notify_user(msg){
            localStorage.setItem("widget_notify_user", true);
            localStorage.setItem("widget_notify_user_msg", msg);
        }

        //Update every so often
        app.addObserver(observer);
        // update for timer
        setInterval(function(){
            console.log("Message Sent: Update");
            widget_notify_user("test");
        },5*1000);
        setInterval(function(){update();},45*1000);
        // update for modified events via 5 min
        setInterval(function(){update(true);},300*1000);
    });
</script>
